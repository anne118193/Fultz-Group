#how to run
# srun -n 512 --cpu-bind=cores --exclusive --zonesort=off shifter lmp_mpich -v SEED 1 -v T 1200 -v P 1.0 -v N 1000 -v REF_LIQ -4.33 -v LABEL Ge_P_N -v RUNSTEPS 1e7 -in in.melt > melt.out

#======================Simulation Parameters====================
variable run_steps         equal ${RUNSTEPS} #maximum number of steps in coexistence simulation 
variable equilibrate_steps equal 300000 #number of steps for system equlibration
variable average_steps     equal 20000 #number of steps used to calculate ference solid and liquid energies

variable ref_en_liq     equal ${REF_LIQ} # reference energy of liquid obtained from liquid run 

variable my_N equal $N              #from bash
variable my_T equal $T              #from bash
variable    my_filename   string ${LABEL} #output filename from bash

variable side equal ($N/4)^(1/3)    #box shape 
variable my_side equal ${side}
variable latparam  equal 4.25        #by default 4.25 for Al

variable lat_2 equal ${side}*${latparam}-0.01 # Line that separates solid and liquid
variable lat equal ${side}*${latparam}
variable dub_lat equal ${side}*${latparam}*2 

print "temp=${my_T}, press=${P}, N=${my_N}, latparam=${latparam}, seed=${SEED}"
#=====================Averages run=============================
#==============================================================

#======================SOLID & Full box==================================
#------------------Box parameters-----------------------------
units       metal 
boundary p p p

box tilt large
read_data       supercell_lammps


#increase lattice to side x side x 2side shape---------
variable dub_side   equal ${side}
replicate ${side} ${side} ${dub_side}

#------------------Potential parameters----------------
mass       1 26.982 #Al

pair_style  mlip mlip.ini
pair_coeff  * *           #  

neighbor    1.0 bin
neigh_modify delay 0 every 1 check yes

#========================Create liquid region=========================
region liquid block 0 ${lat} 0 ${lat} ${lat} ${dub_lat}   #creates liquid region (half of the box)
group  liquid region liquid

region solid block 0 ${lat_2} 0 ${lat_2} 0 ${lat_2}  #creates liquid region (half of the box)
group  solid region solid

#-------------Output and thermo variables---------------------
variable    step    equal step     #simulation step number
variable   temp_    equal temp     #current temperature
variable   temp_sim equal $T       #initial temperature (from bash)
variable    vol     equal vol/atoms       
variable    press   equal press    #current pressure
#--------------------Output files----------------------------
variable dump_name string ${LABEL}_${SEED}_${my_T}


#-----------------------Run---------------------------
#-----------------------------------------------------

#make liquid with nve+langevin----------
fix     liq all nve
variable T_high equal 4*$T #to heat liquid region up to 5*T
fix     liq2 all langevin ${T_high} ${T_high} 10.0 ${SEED} #to melt liquid region

variable C_dT equal c_thermo_pe/atoms   #potential energy
fix     3 all ave/time 1 10000 10000 v_C_dT #average potential energy f_3 (every 10000 steps)
thermo_style custom step temp vol v_side f_3 press #log/screen output
thermo 10000
timestep 0.001

run     30000 #melting steps

unfix liq
unfix liq2

#equlibrate liquid at T----------------
fix      liq3 all npt temp $T $T 1.0 iso $P $P 10.0
run 60000

#equlibrate solid at T---------------
variable xlo_ equal xlo
variable xhi_ equal xhi

variable ylo_ equal ylo
variable yhi_ equal yhi

variable zlo_ equal zlo
variable zhi_ equal zhi

variable xy_ equal xy
variable xz_ equal xz
variable yz_ equal yz


fix      4 all print 10000 "${xlo_} ${xhi_} ${ylo_} ${yhi_} ${zlo_} ${zhi_} ${xy_} ${xz_} ${yz_}" file cell.dat

run ${equilibrate_steps}     #equlibrate system
